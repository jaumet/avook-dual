<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Audiovook Dual â€” AprÃ¨n llengÃ¼es escoltant histÃ²ries</title>
<link rel="stylesheet" href="./css/index.css">
<script type="module" src="./js/auth.js"></script>

<style>

</style>
</head>

<body class="dark">
<div id="loginToast" class="login-toast" role="status" aria-live="polite"></div>
<header>
  <a href="https://audiovook.com/dual/" style="display:flex;align-items:center;gap:.6em;text-decoration:none;color:inherit">
    <img src="./imgs/logo-dual-fons-blau.png" alt="Audiovook Dual logo"/> 
    <h2>Dual</h2>&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;<h5>by Audiovook</h5> 
    <img style="height:20px !important; width:auto;" src="./imgs/logo.png" alt="Audiovook logo"/>
  </a>
  <div class="rightBtns">
    <button id="themeBtn">â˜€ï¸ Clar</button>
    <button id="infoBtn">â“ Ajuda</button>
  </div>
</header>

<main>

  <section id="magicLinkPanel">
    <h3>ğŸ” AccÃ©s per subscriptors</h3>
    <p>Introdueix el teu correu i t'enviarem un enllaÃ§ mÃ gic per iniciar sessiÃ³ sense contrasenya. Funciona en catalÃ  i anglÃ¨s.</p>
    <form id="magicLinkForm">
      <label for="magicLinkEmail">Correu electrÃ²nic</label>
      <div class="magic-input-row">
        <input id="magicLinkEmail" name="email" type="email" required placeholder="tu@correu.com" autocomplete="email" />
        <button type="submit">Envia'm l'enllaÃ§</button>
      </div>
    </form>
    <p id="magicLinkStatus" aria-live="polite"></p>
    <p class="magic-link-hint">Un cop facis clic al correu, et redirigirem de nou aquÃ­ i veurÃ s un missatge confirmant l'accÃ©s.</p>
  </section>

<h3>â„¹ï¸ QuÃ¨ Ã©s Audiovook Dual?</h3>
  <p>
    Audiovook Dual Ã©s una colÂ·lecciÃ³ dâ€™audiorelats bilingÃ¼es que et permet escoltar una mateixa histÃ²ria en dues llengÃ¼es.
    Ã‰s una forma dâ€™aprendre jugant amb el so, la repeticiÃ³ i el context.
  </p>
  <h2 style="text-align:center">ğŸ“š Relats disponibles</h2>

 <!-- Botons de nivell -->
<h3 style="text-align:center">Selecciona nivell:</h3>  <section id="levelSection"></section>

<!-- BotÃ³ per mostrar/ocultar filtres -->
<div id="advancedSearchToggle">
  <button id="toggleFiltersBtn">ğŸ” Cerca avanÃ§ada</button>
</div>

<!-- Barra de filtres (oculta per defecte) -->
<section id="filtersBar" style="display:none;">
  <div class="av-input">
    <input type="text" id="searchInput" placeholder="ğŸ” Cerca per text o tÃ­tol..." />
  </div>
  <div class="av-select" data-placeholder="ColÂ·lecciÃ³">
    <label>ColÂ·lecciÃ³</label>
    <select id="filterColection"></select>
  </div>
  <div class="av-select" data-placeholder="Durada">
    <label>Durada</label>
    <select id="filterDuration"></select>
  </div>
  <div class="av-select" data-placeholder="LlengÃ¼es">
    <label>LlengÃ¼es</label>
    <select id="filterLang"></select>
  </div>
  <div class="av-select" data-placeholder="Edats">
    <label>Edats</label>
    <select id="filterAges"></select>
  </div>
</section>

 
  <!-- Missatge inicial -->
  <div id="helpNote">
    <h3 style="text-align:center">Dual en 3 clics:</h3>
    <p>1ï¸âƒ£ Selecciona quin tipus de textos vols<br>
       2ï¸âƒ£ Tria un relat<br>
       3ï¸âƒ£ AnirÃ s al reproductor i podrÃ s experimentar el sistema Dual</p>
  </div>

  <section id="catalog"></section>
  <div id="helpIcon">â”</div>
</main>

<!-- Modal ajuda -->
<div id="infoModal">
  <div id="infoContent">

  <p>
    Selecciona una llengua principal i una secundÃ ria, ajusta la velocitat i gaudeix de la histÃ²ria. 
    Pots alternar lâ€™ordre de les llengÃ¼es o escoltar nomÃ©s una versiÃ³.
  </p>

  <hr style="margin:1em 0;border:none;border-top:1px solid var(--accent,#f7836a);">

  <h3>ğŸŸ¢ Consells per gaudir i aprendre</h3>

  <ul style="line-height:1.6;">
    <li><b>ğŸµ Escolta com si fos mÃºsica:</b><br>
    No cal entendre cada paraula ni traduir mentalment. Deixaâ€™t portar pel ritme, la melodia i les pauses de la veu. Repetint escoltes, el significat apareixerÃ  de manera intuÃ¯tiva.</li>

    <li><b>ğŸ” Juga amb lâ€™ordre de les llengÃ¼es:</b><br>
    Pots comenÃ§ar escoltant primer la teva llengua i desprÃ©s la nova, desprÃ©s al contrari, i finalment nomÃ©s la nova. Cada ordre activa parts diferents del cervell i reforÃ§a la comprensiÃ³.</li>

    <li><b>ğŸ—£ï¸ Llegeix i escolta:</b><br>
    Aprofita que veus el text per llegir-lo alhora que lâ€™escoltes. Compara la pronunciaciÃ³ i el ritme de la veu amb la teva lectura. Escriu o repeteix els fragments que mÃ©s tâ€™agradin: Ã©s una manera excelÂ·lent de fixar vocabulari i estructura.</li>

    <li><b>âš™ï¸ Ajusta la velocitat:</b><br>
    Si et costa seguir, redueix la velocitat fins que reconeguis paraules i patrons. Quan et sentis mÃ©s segur, accelera fins al ritme natural de la parla.</li>

    <li><b>ğŸ§ Escolta amb auriculars:</b><br>
    Et permetrÃ  captar millor la pronunciaciÃ³, la musicalitat i els detalls de la veu. Si pots, utilitza uns auriculars tancats que aÃ¯llin el soroll exterior.</li>

    <li><b>ğŸ‘ï¸ Imagina el relat:</b><br>
    Tanca els ulls i visualitza el que passa. Imaginar reforÃ§a la memÃ²ria i et connecta emocionalment amb el llenguatge.</li>

    <li><b>ğŸ“– Repassa el vocabulari:</b><br>
    DesprÃ©s dâ€™escoltar, intenta recordar paraules o frases noves. No cal apuntar-ho tot: tria les que tâ€™hagin cridat mÃ©s lâ€™atenciÃ³.</li>

    <li><b>â³ Torna-hi mÃ©s endavant:</b><br>
    Cada escolta tâ€™aporta coses noves i consolida lâ€™aprenentatge sense pressa. Lâ€™aprenentatge auditiu millora quan hi ha repeticions espaiades en el temps.</li>

    <li><b>ğŸŒ Gaudeix de la diversitat:</b><br>
    Cada histÃ²ria i cada veu provenen dâ€™una cultura diferent. Deixaâ€™t sorprendre per les expressions, els accents i les formes de dir les coses.</li>
  </ul>

  <p><b>Recorda:</b> aprendre una llengua Ã©s una experiÃ¨ncia auditiva i emocional. 
  Amb Audiovook Dual, pots aprendre escoltant histÃ²ries, sense pressiÃ³ i amb plaer.</p>


    <button id="closeModal">Tanca</button>
  </div>
</div>

<script>
const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
const API_BASE_URL = window.__AVOOK_API_BASE__ ||
  (isLocalhost
    ? `${window.location.protocol}//${window.location.hostname}:8000`
    : 'https://api.audiovook.com');

setupMagicLinkForm();
handleLoginToastFromQuery();

async function loadCatalog(){
  const data = await fetchCatalogIndex();
  const base = data.AUDIOS || {};
  const catalog = document.getElementById('catalog');
  catalog.innerHTML = '';
  catalog.style.display = 'none';

  for (const title in base) {
    const i = base[title];
    const img = resolveImagePath(i.image, title);
    const human = i["title-human"] || title;

    // NomÃ©s afegim si el valor existeix i no Ã©s buit
    const colection = i.colection && i.colection.trim() !== "" ? `<span class="colection">${i.colection}</span>` : "";
    const levels    = i.levels && i.levels.trim() !== ""       ? `<span class="level">${i.levels}</span>` : "";
    const ages      = i.ages && i.ages.trim() !== ""           ? `<span class="ages">${i.ages}</span>` : "";
    const duration  = i.duration && i.duration.trim() !== ""   ? `<span class="duration">${i.duration}</span>` : "";
    const langs     = i.langs && i.langs.trim() !== ""         ? `<div class="langList">${i.langs}</div>` : "";
    const desc      = i.description && i.description.trim() !== "" ? `<div class="description">${i.description}</div>` : "";

    const metaTop = (levels || ages)
      ? `<div class="meta-top">${levels}${ages}</div>`
      : "";

    const meta = (colection || duration)
      ? `<div class="meta">${colection}${duration}</div>`
      : "";

    const card = document.createElement('div');
    card.className = 'titleCard';
    card.innerHTML = `
      <img src="${img}" alt="${human}">
      ${metaTop}
      <div class="cardText">
        <h3>${human}</h3>
        ${meta}
        ${langs}
        ${desc}
      </div>
    `;
    card.onclick = () => {
      window.location.href = `./player.html?title=${encodeURIComponent(title)}`;
    };
    catalog.appendChild(card);
  }

  initFilters(data);
}

async function fetchCatalogIndex(){
  const token = localStorage.getItem('av_jwt') || localStorage.getItem('audiovook_token');
  const authHeaders = token ? { Authorization: `Bearer ${token}` } : undefined;
  const freeData = await fetchFreeCatalog(authHeaders);
  const merged = {
    PATH_AUDIOS: freeData.PATH_AUDIOS || '/AUDIOS/',
    AUDIOS: { ...(freeData.AUDIOS || {}) }
  };

  const packageIds = await fetchUserPackages(authHeaders);
  const uniquePackages = [...new Set(packageIds)];
  if(uniquePackages.length){
    const results = await Promise.all(
      uniquePackages.map((pkgId) => fetchPackageCatalog(pkgId, authHeaders).catch(() => null))
    );
    results.forEach(pkg => {
      if(pkg && pkg.AUDIOS){
        Object.assign(merged.AUDIOS, pkg.AUDIOS);
      }
    });
  }

  return merged;
}

async function fetchFreeCatalog(authHeaders){
  const loadFallback = async () => {
    const res = await fetch('./audios-free.json');
    if(!res.ok) throw new Error('No s\'ha pogut carregar el catÃ leg obert.');
    return res.json();
  };

  try {
    const options = { credentials: 'include' };
    if(authHeaders) options.headers = authHeaders;
    const res = await fetch(`${API_BASE_URL}/catalog/free`, options);
    if(!res.ok) throw new Error('No s\'ha pogut carregar el catÃ leg obert.');
    return res.json();
  } catch (error){
    console.warn('Fent servir el catÃ leg inclÃ²s al projecte.', error);
    return loadFallback();
  }
}

async function fetchUserPackages(authHeaders){
  try {
    const options = { credentials: 'include' };
    if(authHeaders) options.headers = authHeaders;
    const res = await fetch(`${API_BASE_URL}/auth/me`, options);
    if(!res.ok) return [];
    const data = await res.json().catch(() => ({}));
    return Array.isArray(data.packages) ? data.packages : [];
  } catch (err){
    console.warn('No s\'han pogut obtenir els paquets', err);
    return [];
  }
}

async function fetchPackageCatalog(packageId, authHeaders){
  try {
    const options = { credentials: 'include' };
    if(authHeaders) options.headers = authHeaders;
    const res = await fetch(`${API_BASE_URL}/catalog/packages/${encodeURIComponent(packageId)}`, options);
    if(!res.ok){
      if(![401,403,404].includes(res.status)){
        console.warn(`Error carregant el paquet ${packageId}`, res.status);
      }
      return null;
    }
    return res.json();
  } catch (err){
    console.warn(`No s'ha pogut carregar el paquet ${packageId}`, err);
    return null;
  }
}

const filters = { text:'', colection:'', levels:[], duration:'', lang:'', ages:'' };

function fillSelect(id,set){
  const sel=document.querySelector(id);
  if(!sel)return;
  const opt0=document.createElement('option');
  opt0.value=''; opt0.textContent='â€”';
  sel.appendChild(opt0);
  [...set].sort().forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v; opt.textContent=v;
    sel.appendChild(opt);
  });
}

async function initFilters(data){
  const base = data.AUDIOS || {};

  // definim conjunts
  const colSet = new Set();
  const levSet = new Set();
  const durSet = new Set();
  const langSet = new Set();
  const ageSet = new Set();

  // recollim valors dels camps
  for(const t in base){
    const i = base[t];
    if(i.colection) colSet.add(i.colection.trim());
    if(i.levels) levSet.add(i.levels.trim());
    if(i.duration) durSet.add(i.duration.trim());
    if(i.ages) ageSet.add(i.ages.trim());
    if(i.langs) i.langs.split(',').map(x=>x.trim().toUpperCase()).forEach(l=>langSet.add(l));
  }

  // omplim desplegables
  fillSelect('#filterColection', colSet);
  fillSelect('#filterDuration',  durSet);
  fillSelect('#filterLang',      langSet);
  fillSelect('#filterAges',      ageSet);

  // creem botons de nivell
  const levelSection = document.getElementById('levelSection');
  levelSection.innerHTML = '';
  [...levSet].sort().forEach(l=>{
    const btn = document.createElement('button');
    btn.className = 'levelBtn';
    btn.textContent = l;
    btn.onclick = () => {
      btn.classList.toggle('active');
      if (btn.classList.contains('active')) {
        if (!filters.levels.includes(l)) filters.levels.push(l);
      } else {
        filters.levels = filters.levels.filter(x=>x!==l);
      }
      applyFilters();
    };
    levelSection.appendChild(btn);
  });

  // âœ… actualitzem visualment els selects
  setupFakeSelects();
}

function applyFilters(){
  const cards = document.querySelectorAll('#catalog .titleCard');
  let anyVisible = false;

  const anyFilterActive =
    (filters.text && filters.text.length > 0) ||
    (filters.levels && filters.levels.length > 0) ||
    filters.colection || filters.duration || filters.lang || filters.ages;

  cards.forEach(card => {
    const txt = card.textContent.toLowerCase();

    // llegim dades especÃ­fiques del card
    const cardLevel = card.querySelector('.level')?.textContent.trim().toLowerCase() || '';
    const cardLangs = (card.querySelector('.langList')?.textContent || '')
      .replace('ğŸŒ LlengÃ¼es:', '')
      .split(/[,\s]+/)
      .map(l => l.trim().toUpperCase())
      .filter(Boolean);

    let visible = true;
    if (!anyFilterActive) visible = false;

    // text
    if (visible && filters.text && !txt.includes(filters.text)) visible = false;

    // nivells (OR)
    if (visible && filters.levels.length > 0) {
      const wanted = filters.levels.map(l => l.toLowerCase());
      if (!wanted.includes(cardLevel)) visible = false;
    }

    // llengÃ¼es (exact match)
    if (visible && filters.lang) {
      const wantedLang = filters.lang.trim().toUpperCase();
      if (!cardLangs.includes(wantedLang)) visible = false;
    }

    // altres dropdowns (AND)
    if (visible && filters.colection && !txt.includes(filters.colection.toLowerCase())) visible = false;
    if (visible && filters.duration && !txt.includes(filters.duration.toLowerCase())) visible = false;
    if (visible && filters.ages && !txt.includes(filters.ages.toLowerCase())) visible = false;

    card.style.display = visible ? 'flex' : 'none';
    if (visible) anyVisible = true;
  });

  // mostrar o amagar elements
  const catalog = document.getElementById('catalog');
  const help = document.getElementById('helpNote');
  const helpIcon = document.getElementById('helpIcon');

  catalog.style.display = anyVisible ? 'flex' : 'none';
  help.style.display = anyVisible ? 'none' : 'block';
  helpIcon.style.display = anyVisible ? 'flex' : 'none';
}



function resolveImagePath(imgPath,title){
  if(!imgPath) return `./AUDIOS/${title}/${title}.png`;
  if(/^https?:\/\//i.test(imgPath)) return imgPath;
  return `./AUDIOS/${title}/${imgPath.replace(/^\.?\/*/,'')}`;
}

const modal=document.getElementById('infoModal');
document.getElementById('infoBtn').onclick=()=>modal.style.display='flex';
document.getElementById('helpIcon').onclick=()=>modal.style.display='flex';
document.getElementById('closeModal').onclick=()=>modal.style.display='none';
window.onclick=e=>{if(e.target==modal)modal.style.display='none';};

// âœ… Cerca per text
document.addEventListener('input', (e) => {
  if (e.target.id === 'searchInput') {
    filters.text = e.target.value.trim().toLowerCase();
    applyFilters();
  }
});

// âœ… Dropdowns (ColÂ·lecciÃ³, Durada, LlengÃ¼es, Edats)
document.addEventListener('change', (e) => {
  if (e.target.matches('#filterColection, #filterDuration, #filterLang, #filterAges')) {
    const key = e.target.id.replace('filter', '').toLowerCase(); // colection, duration, lang, ages
    filters[key] = e.target.value || '';
    applyFilters();
  }
});

function setupFakeSelects(){
  document.querySelectorAll('#filtersBar .av-select select').forEach(sel=>{
    const wrap = sel.parentElement;
    const setLabel = () => {
      const idx = sel.selectedIndex;
      const txt = idx >= 0 ? sel.options[idx].text : '';
      wrap.setAttribute('data-value', txt);
      // opcional: placeholder gris si Ã©s la 1a opciÃ³
      if (idx === 0) sel.style.color = '#999'; else sel.style.color = '';
    };
    sel.addEventListener('change', setLabel);
    setLabel();
  });
}

function setupMagicLinkForm(){
  const form = document.getElementById('magicLinkForm');
  const statusEl = document.getElementById('magicLinkStatus');
  if(!form || !statusEl) return;

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const emailInput = form.querySelector('input[name="email"]');
    const email = emailInput?.value.trim();
    if(!email){
      statusEl.textContent = 'Introdueix un correu vÃ lid.';
      statusEl.dataset.state = 'error';
      return;
    }

    statusEl.textContent = 'Enviant enllaÃ§...';
    statusEl.dataset.state = 'loading';

    try {
      const res = await fetch(`${API_BASE_URL}/auth/magic-link/request`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        const detail = data.detail || 'No hem pogut enviar l\'enllaÃ§. Torna-ho a provar mÃ©s tard.';
        throw new Error(detail);
      }
      const message = data.detail || 'Si el correu existeix, ja tens l\'enllaÃ§ al teu inbox.';
      statusEl.textContent = message;
      statusEl.dataset.state = 'success';
      form.reset();
      showLoginToast('Hem enviat l\'enllaÃ§. Revisa la teva safata.', 'ok');
    } catch (err){
      statusEl.textContent = err.message || 'Error desconegut.';
      statusEl.dataset.state = 'error';
      showLoginToast('No hem pogut enviar l\'enllaÃ§.', 'error');
    }
  });
}

function handleLoginToastFromQuery(){
  const params = new URLSearchParams(window.location.search);
  const loginStatus = params.get('login');
  if(loginStatus === 'ok'){
    showLoginToast('SessiÃ³ iniciada! Ja pots escoltar els relats.', 'ok');
  } else if(loginStatus === 'error'){
    showLoginToast('Hi ha hagut un problema amb l\'enllaÃ§.', 'error');
  }
  if(loginStatus){
    params.delete('login');
    const newUrl = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
    window.history.replaceState({}, '', newUrl);
  }
}

function showLoginToast(message, tone = 'ok'){
  const toast = document.getElementById('loginToast');
  if(!toast) return;
  toast.textContent = message;
  toast.classList.remove('ok', 'error');
  toast.classList.add('visible', tone === 'error' ? 'error' : 'ok');
  clearTimeout(showLoginToast._timer);
  showLoginToast._timer = setTimeout(() => {
    toast.classList.remove('visible');
  }, 6000);
}

loadCatalog();

// âœ… Mostrar / ocultar filtres avanÃ§ats
document.getElementById('toggleFiltersBtn').addEventListener('click', () => {
  const filters = document.getElementById('filtersBar');
  const btn = document.getElementById('toggleFiltersBtn');
  const visible = filters.style.display !== 'none';
  filters.style.display = visible ? 'none' : 'flex';
  btn.textContent = visible ? 'ğŸ” Cerca avanÃ§ada' : 'âœ–ï¸ Amaga filtres';
});

</script>
</body>
</html>
